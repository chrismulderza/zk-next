#!/bin/bash

# zk-next CLI tool

DIR="$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")"

# Show help information
show_help() {
  cat << 'EOF'
zk-next - Zettelkasten note management tool

USAGE:
    zkn [--help] [--debug] <command> [arguments]

COMMANDS:
    add [TYPE]          Create a new note from a template
                        TYPE defaults to 'note' if not specified
                        Available types depend on configured templates
                        Options: --title, --tags (see below)
                        If neither --title nor --tags provided, prompts interactively

    init                Initialize a new notebook directory
                        Creates .zk directory and default config.yaml

    reindex             Re-index all markdown files in the notebook
                        Scans notebook directory recursively and updates SQLite index

    completion          Generate bash completion script
    _completion         Alias for 'completion' command

OPTIONS:
    --help, -h          Show this help message
    --debug, -d         Enable debug output (shows template resolution details)

ADD COMMAND OPTIONS:
    --title, -t TITLE   Set the note title (can contain spaces)
    --tags TAGS         Set tags as comma-separated list (e.g., "tag1, tag2, tag3")
                        If neither --title nor --tags provided, prompts interactively

EXAMPLES:
    zkn add             Create a note using default 'note' template (prompts for title/tags)
    zkn add journal     Create a note using 'journal' template (prompts for title/tags)
    zkn add --title "My Note" journal
                        Create a journal note with title "My Note" (prompts for tags)
    zkn add --title "My Note" --tags "work, project"
                        Create a note with title and tags (no prompts)
    zkn --debug add     Create a note with debug output
    zkn init            Initialize notebook in current directory
    zkn reindex         Re-index all notes in the notebook
    zkn completion      Generate and source completion script

SHELL COMPLETION:
    To enable bash completion:
        source <(zkn completion)

    Or add to ~/.bashrc or ~/.zshrc:
        source <(zkn completion)
EOF
}

# Check for debug flag
DEBUG_MODE=0
if [ "$1" = "--debug" ] || [ "$1" = "-d" ]; then
  DEBUG_MODE=1
  shift
fi

COMMAND=$1

shift

# Handle --help before command processing
if [ -z "$COMMAND" ] || [ "$COMMAND" = "--help" ] || [ "$COMMAND" = "-h" ]; then
  show_help
  exit 0
fi

case $COMMAND in
  _completion|completion)
    # Generate bash completion script
    CMD_DIR="$DIR/../lib/cmd"
    HELPER_SCRIPT="$DIR/../lib/cmd/_completion_helper.rb"
    echo "# zk-next bash completion"
    echo "_zkn() {"
    echo "  local cur prev words cword"
    echo "  COMPREPLY=()"
    echo "  cur=\"\${COMP_WORDS[COMP_CWORD]}\""
    echo "  prev=\"\${COMP_WORDS[COMP_CWORD-1]}\""
    echo ""
    echo "  # If completing the first word (command name), list all commands"
    echo "  if [ \$COMP_CWORD -eq 1 ]; then"
    echo "    # Dynamically discover commands from lib/cmd/ directory"
    echo "    local commands"
    echo "    commands=\$(find \"$CMD_DIR\" -name '*.rb' -type f ! -name '_completion_helper.rb' -exec basename {} .rb \\;)"
    echo "    COMPREPLY=(\$(compgen -W \"\$commands\" -- \"\$cur\"))"
    echo "    return 0"
    echo "  fi"
    echo ""
    echo "  # Check if completing an option (starts with --)"
    echo "  if [[ \"\$cur\" == --* ]]; then"
    echo "    # Common options available for all commands"
    echo "    local common_opts"
    echo "    common_opts=\$(ruby \"$HELPER_SCRIPT\" common_options 2>/dev/null || echo '--help --version')"
    echo "    COMPREPLY=(\$(compgen -W \"\$common_opts\" -- \"\$cur\"))"
    echo "    return 0"
    echo "  fi"
    echo ""
    echo "  # Command-specific argument completions (dynamically from commands)"
    echo "  local cmd=\"\${COMP_WORDS[1]}\""
    echo "  if [ -n \"\$cmd\" ] && [ \$COMP_CWORD -gt 1 ]; then"
    echo "    # Dynamically get completions from command"
    echo "    local completions"
    echo "    completions=\$(ruby \"$CMD_DIR/\${cmd}.rb\" --completion 2>/dev/null)"
    echo "    if [ -n \"\$completions\" ]; then"
    echo "      COMPREPLY=(\$(compgen -W \"\$completions\" -- \"\$cur\"))"
    echo "      return 0"
    echo "    fi"
    echo "  fi"
    echo "}"
    echo "complete -F _zkn zkn"
    ;;
  add)
    if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
      show_help
      exit 0
    fi
    if [ "$DEBUG_MODE" -eq 1 ]; then
      export ZKN_DEBUG=1
    fi
    echo "running ruby $DIR/../lib/cmd/add.rb $@"
    ruby "$DIR/../lib/cmd/add.rb" "$@"
    ;;
  init)
    if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
      show_help
      exit 0
    fi
    ruby "$DIR/../lib/cmd/init.rb" "$@"
    ;;
  reindex)
    if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
      show_help
      exit 0
    fi
    if [ "$DEBUG_MODE" -eq 1 ]; then
      export ZKN_DEBUG=1
    fi
    ruby "$DIR/../lib/cmd/reindex.rb" "$@"
    ;;
  *)
    echo "Usage: zkn <command> [options]"
    echo "Commands: add, init, reindex, completion"
    echo "Run 'zkn --help' for more information."
    exit 1
    ;;
esac
