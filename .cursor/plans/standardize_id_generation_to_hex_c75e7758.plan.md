---
name: Standardize ID generation to hex
overview: Change ID generation for new notes from Unix timestamp to 8-character hex ID to match the strategy used for loaded/imported notes. This ensures consistency across all note creation paths.
todos:
  - id: update-utils-generate-id
    content: Update Utils.generate_id to generate 8-character hex ID (currently 6-character)
    status: pending
  - id: update-document-generate-id
    content: Change Document.generate_id to delegate to Utils.generate_id for shared implementation
    status: pending
  - id: update-utils-current-time-vars
    content: Change Utils.current_time_vars to use Utils.generate_id instead of Unix timestamp
    status: pending
  - id: update-test-assertions
    content: Update test assertions to check for 8-character hex format instead of numeric or 6-character hex
    status: pending
  - id: update-architecture-docs
    content: Update ARCHITECTURE.md to document shared ID generation strategy and hex format
    status: completed
  - id: update-readme-docs
    content: Update README.md to document hex ID format in variable interpolation section
    status: completed
---

## Problem Analysis

Currently, ID generation uses two different strategies:

- **New notes** (via `zk add`): Unix timestamp string (e.g., `"1738000000"`) generated in `Utils.current_time_vars`
- **Loaded/imported notes**: 8-character hex ID (e.g., `"a1b2c3d4"`) generated by `Document.generate_id`

This inconsistency should be unified to use the 8-character hex ID strategy for all notes.

## Solution

Create a shared ID generation method in `Utils` that both `Document.generate_id` and `Utils.current_time_vars` will use. This ensures:

1. All notes use consistent 8-character hex ID format
2. ID generation logic is centralized in one place for future changes
3. Both creation paths (new notes and loaded notes) use the same implementation

## Implementation

### Code Changes

**1. Update [`lib/utils.rb`](lib/utils.rb) - Create/update shared ID generation method**:

Update the existing `Utils.generate_id` method to generate 8-character hex IDs (currently it generates 6-character hex IDs):

```ruby
# Current (lines 75-77):
def self.generate_id
  SecureRandom.hex(3)  # 6-character hex ID
end

# New:
def self.generate_id
  SecureRandom.hex(4)  # 8-character hex ID (matches Document.generate_id)
end
```

**2. Update [`lib/models/document.rb`](lib/models/document.rb) - Use shared method**:

Change `Document.generate_id` to call `Utils.generate_id` instead of implementing its own logic:

```ruby
# Current (lines 35-37):
def self.generate_id
  SecureRandom.hex(ZK_DEFAULT_ID_LENGTH / 2)
end

# New:
def self.generate_id
  Utils.generate_id
end
```

**3. Update [`lib/utils.rb`](lib/utils.rb) - `current_time_vars` method**:

Change the `id` generation from Unix timestamp to use the shared method:

```ruby
# Current (line 41):
'id' => now.to_i.to_s

# New:
'id' => Utils.generate_id  # Use shared ID generation method
```

**4. Update [`test/utils_test.rb`](test/utils_test.rb) - Update ID generation tests**:

Update `test_current_time_vars_id_is_string` to check for hex format instead of numeric:

Update the assertion to check for hex format instead of numeric:

```ruby
# Current (lines 280-284):
def test_current_time_vars_id_is_string
  vars = Utils.current_time_vars
  assert vars['id'].is_a?(String)
  assert_match(/^\d+$/, vars['id'])  # Checks for numeric
end

# New:
def test_current_time_vars_id_is_string
  vars = Utils.current_time_vars
  assert vars['id'].is_a?(String)
  assert_match(/^[0-9a-f]{8}$/, vars['id'])  # Checks for 8-character hex
end
```

Also update any tests for `Utils.generate_id` if they check for 6-character format (should now be 8-character).

**5. Update [`test/models/document_test.rb`](test/models/document_test.rb)**:

Verify that `Document.generate_id` tests still pass (they should, since it now delegates to `Utils.generate_id`).

**6. Update [`ARCHITECTURE.md`](ARCHITECTURE.md)**:

Update the documentation for `current_time_vars`:

```markdown
# Current (line 315):
- `id`: Unix timestamp as string

# New:
- `id`: 8-character hexadecimal ID (generated using SecureRandom)
```

**7. Update [`README.md`](README.md)**:

Update the variable interpolation documentation:

```markdown
# Current (line 125):
- `{id}` - Note ID (Unix timestamp)

# New:
- `{id}` - Note ID (8-character hexadecimal)
```

### Testing

**5. Verify existing tests still pass**:

- Run `make test` to ensure all tests pass
- The change should not break any existing functionality since:
  - ID format changes from numeric to hex, but still a string
  - Filename patterns using `{id}` will work the same way
  - Database indexing should handle hex IDs the same as numeric IDs

**9. Check for any other tests that might expect numeric IDs**:

- Review `test/cmd/add_test.rb` for any assertions checking ID format
- The alias pattern test at line 923 checks for `\d+` in aliases - this should still work since it's checking the ID within the alias string, not the ID format itself

### Files to Modify

- [`lib/utils.rb`](lib/utils.rb) - Update `generate_id` to 8-character hex and use it in `current_time_vars`
- [`lib/models/document.rb`](lib/models/document.rb) - Change `Document.generate_id` to delegate to `Utils.generate_id`
- [`test/utils_test.rb`](test/utils_test.rb) - Update test assertions to check for 8-character hex format
- [`test/models/document_test.rb`](test/models/document_test.rb) - Verify tests still pass (should work as-is)
- [`ARCHITECTURE.md`](ARCHITECTURE.md) - Update documentation for ID generation strategy
- [`README.md`](README.md) - Update variable interpolation documentation for `{id}` format

### Notes

- `SecureRandom.hex(4)` generates exactly 8 hex characters
- By centralizing ID generation in `Utils.generate_id`, future changes to ID format/length can be made in one place
- `Document.generate_id` now delegates to `Utils.generate_id`, ensuring both paths use identical logic
- The `ZK_DEFAULT_ID_LENGTH` constant in `Document` can remain for backward compatibility or be removed if not used elsewhere
- This change ensures consistency: all notes (new and loaded) will use the same 8-character hex ID format
- The change is backward compatible in terms of functionality - IDs are still strings, just with a different format
- Existing notes with timestamp IDs will continue to work; only new notes will use hex IDs